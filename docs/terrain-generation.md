# 地形生成システム ドキュメント

## 概要

このドキュメントでは、city-simプロジェクトの地形生成システムについて説明します。システムにはパーリンノイズを採用しました。

## 地形生成の流れ

### 1. 初期化フェーズ
- シードベースの乱数生成器を初期化
- 4方向（北・東・南・西）からランダムに2方向を選択
- 選択された方向に水辺ポイントを配置

### 2. ノイズ生成フェーズ
- 高度マップ：パーリンノイズで地形の起伏を生成
- 湿度マップ：高度とは異なるスケールで湿度分布を生成
- 水辺距離マップ：各タイルから最も近い水辺ポイントまでの距離を計算

### 3. 地形決定フェーズ
- 水辺エリアの判定
- 砂浜エリアの判定
- 低地エリアの判定
- 山岳・森林エリアの判定
- 平地エリアの判定

### 4. 連続性改善フェーズ
- 隣接タイルの地形を分析
- 地形の連続性を向上
- 不自然な地形の切り替わりを防止

## 定数パラメータの詳細

### WATER（水辺・砂浜の設定）

| 定数名 | 値 | 効果 | 調整時の影響 |
|--------|----|----|-------------|
| `EDGE_THRESHOLD_RATIO` | 0.12 | 境界付近の水辺エリア比率 | 値を大きくすると水辺エリアが広がる |
| `POINT_STRENGTH_MIN` | 0.9 | 水辺ポイントの最小強度 | 値を大きくすると水辺の影響範囲が拡大 |
| `POINT_STRENGTH_MAX` | 1.2 | 水辺ポイントの最大強度 | 値を大きくすると水辺の影響範囲が拡大 |
| `DISTANCE_THRESHOLD` | 5 | 水辺エリアの距離閾値 | 値を大きくすると水辺エリアが拡大 |
| `NORTH_POINTS_RATIO` | 0.4 | 北側水辺ポイントの比率 | 値を大きくすると北側の水辺が密集 |
| `EAST_POINTS_RATIO` | 0.4 | 東側水辺ポイントの比率 | 値を大きくすると東側の水辺が密集 |
| `SOUTH_POINTS_RATIO` | 0.4 | 南側水辺ポイントの比率 | 値を大きくすると南側の水辺が密集 |
| `WEST_POINTS_RATIO` | 0.4 | 西側水辺ポイントの比率 | 値を大きくすると西側の水辺が密集 |
| `NORTH_Y_RATIO` | 0.12 | 北側水辺のY座標比率 | 値を小さくすると北側の水辺が境界に近づく |
| `EAST_X_RATIO` | 0.88 | 東側水辺のX座標比率 | 値を大きくすると東側の水辺が境界に近づく |
| `SOUTH_Y_RATIO` | 0.88 | 南側水辺のY座標比率 | 値を大きくすると南側の水辺が境界に近づく |
| `WEST_X_RATIO` | 0.12 | 西側水辺のX座標比率 | 値を小さくすると西側の水辺が境界に近づく |

### BEACH（砂浜の設定）

| 定数名 | 値 | 効果 | 調整時の影響 |
|--------|----|----|-------------|
| `THRESHOLD_OFFSET` | 8 | 水辺エリアからの砂浜オフセット | 値を大きくすると砂浜エリアが拡大 |
| `DISTANCE_MIN` | 5 | 砂浜生成の最小距離 | 値を小さくすると砂浜が水辺に近づく |
| `DISTANCE_MAX` | 10 | 砂浜生成の最大距離 | 値を大きくすると砂浜エリアが拡大 |
| `HEIGHT_THRESHOLD` | 0.6 | 砂浜生成の高さ閾値 | 値を大きくすると高い場所にも砂浜が生成 |

### LOWLAND（低地の設定）

| 定数名 | 値 | 効果 | 調整時の影響 |
|--------|----|----|-------------|
| `DISTANCE_BASE` | 10 | 低地生成の基本距離 | 値を大きくすると低地エリアが拡大 |
| `DISTANCE_VARIANCE` | 1 | 低地生成の距離変動 | 値を大きくすると低地の境界が不規則になる |
| `HEIGHT_THRESHOLD` | 0.45 | 低地生成の高さ閾値 | 値を大きくすると高い場所にも低地が生成 |
| `MOISTURE_THRESHOLD` | 0.65 | 低地生成の湿度閾値 | 値を小さくすると乾燥した場所にも低地が生成 |

### MOUNTAIN（山岳の設定）

| 定数名 | 値 | 効果 | 調整時の影響 |
|--------|----|----|-------------|
| `WATER_DISTANCE_MIN` | 20 | 山岳生成の最小水辺距離 | 値を小さくすると水辺の近くにも山岳が生成 |
| `HEIGHT_THRESHOLD` | 0.575 | 山岳生成の高さ閾値 | 値を小さくすると低い場所にも山岳が生成 |
| `BASE_CHANCE` | 0.9 | 山岳生成の基本確率 | 値を大きくすると山岳の生成確率が上昇 |
| `HEIGHT_MULTIPLIER` | 3 | 高さによる確率倍率 | 値を大きくすると高さによる山岳生成の影響が強くなる |
| `CONTINUITY_THRESHOLD` | 0.325 | 山岳の連続性閾値 | 値を小さくすると山岳が広範囲に連続して生成 |
| `SECONDARY_HEIGHT` | 0.54 | 二次的な山岳生成の高さ閾値 | 値を小さくすると中程度の高さでも山岳が生成 |

### FOREST（森林の設定）

| 定数名 | 値 | 効果 | 調整時の影響 |
|--------|----|----|-------------|
| `WATER_DISTANCE_MIN` | 20 | 森林生成の最小水辺距離 | 値を小さくすると水辺の近くにも森林が生成 |
| `WATER_DISTANCE_MID_MIN` | 10 | 中距離森林生成の最小距離 | 値を小さくすると水辺に近い場所でも森林が生成 |
| `WATER_DISTANCE_MID_MAX` | 15 | 中距離森林生成の最大距離 | 値を大きくすると中距離エリアでの森林生成が拡大 |
| `HEIGHT_THRESHOLD_HIGH` | 0.425 | 高地森林生成の高さ閾値 | 値を小さくすると低い場所にも高地森林が生成 |
| `HEIGHT_THRESHOLD_MID` | 0.25 | 中地森林生成の高さ閾値 | 値を小さくすると低い場所にも中地森林が生成 |
| `HEIGHT_THRESHOLD_MID_DISTANCE` | 0.4 | 中距離森林生成の高さ閾値 | 値を小さくすると低い場所にも中距離森林が生成 |
| `MOISTURE_THRESHOLD_HIGH` | 0.525 | 高地森林生成の湿度閾値 | 値を小さくすると乾燥した場所にも高地森林が生成 |
| `MOISTURE_THRESHOLD_MID` | 0.6 | 中地森林生成の湿度閾値 | 値を小さくすると乾燥した場所にも中地森林が生成 |
| `MOISTURE_THRESHOLD_LOW` | 0.65 | 低地森林生成の湿度閾値 | 値を小さくすると乾燥した場所にも低地森林が生成 |
| `MOISTURE_THRESHOLD_MID_DISTANCE` | 0.6 | 中距離森林生成の湿度閾値 | 値を小さくすると乾燥した場所にも中距離森林が生成 |
| `MOISTURE_THRESHOLD_MID_DISTANCE_HIGH` | 0.7 | 中距離森林生成の高湿度閾値 | 値を小さくすると乾燥した場所にも中距離森林が生成 |
| `CONTINUITY_THRESHOLD` | 0.35 | 森林の連続性閾値 | 値を小さくすると森林が広範囲に連続して生成 |

### NOISE（ノイズ生成の設定）

| 定数名 | 値 | 効果 | 調整時の影響 |
|--------|----|----|-------------|
| `HEIGHT_SCALE` | 0.025 | 高度ノイズのスケール | 値を大きくすると地形の起伏が細かくなる |
| `MOISTURE_SCALE` | 0.04 | 湿度ノイズのスケール | 値を大きくすると湿度の変化が細かくなる |
| `OCTAVES` | 5 | ノイズのオクターブ数 | 値を大きくすると地形がより複雑になる |
| `PERSISTENCE` | 0.55 | ノイズの持続性 | 値を大きくすると高周波ノイズの影響が強くなる |
| `MOISTURE_OFFSET` | 1000 | 湿度ノイズのオフセット | 値を大きくすると高度と湿度の相関が弱くなる |

## 地形生成の調整例

### 山岳を増やしたい場合
```typescript
MOUNTAIN: {
  HEIGHT_THRESHOLD: 0.5,        // 0.575 → 0.5 に下げる
  BASE_CHANCE: 0.95,            // 0.9 → 0.95 に上げる
  CONTINUITY_THRESHOLD: 0.25,   // 0.325 → 0.25 に下げる
}
```

### 森林を増やしたい場合
```typescript
FOREST: {
  WATER_DISTANCE_MIN: 15,       // 20 → 15 に下げる
  HEIGHT_THRESHOLD_HIGH: 0.35,  // 0.425 → 0.35 に下げる
  MOISTURE_THRESHOLD_HIGH: 0.45, // 0.525 → 0.45 に下げる
  CONTINUITY_THRESHOLD: 0.25,   // 0.35 → 0.25 に下げる
}
```

### 水辺エリアを拡大したい場合
```typescript
WATER: {
  EDGE_THRESHOLD_RATIO: 0.15,   // 0.12 → 0.15 に上げる
  DISTANCE_THRESHOLD: 8,        // 5 → 8 に上げる
  POINT_STRENGTH_MIN: 1.0,      // 0.9 → 1.0 に上げる
  POINT_STRENGTH_MAX: 1.5,      // 1.2 → 1.5 に上げる
}
```

### 砂浜エリアを拡大したい場合
```typescript
BEACH: {
  THRESHOLD_OFFSET: 12,         // 8 → 12 に上げる
  DISTANCE_MAX: 15,             // 10 → 15 に上げる
  HEIGHT_THRESHOLD: 0.7,        // 0.6 → 0.7 に上げる
}
```

## 注意事項

1. **パラメータの相互依存性**: 各パラメータは独立していないため、一つの値を変更すると他の地形にも影響する可能性があります。

2. **パフォーマンス**: `OCTAVES`や`PERSISTENCE`の値を大きくすると、地形生成の処理時間が増加します。まあ大した負荷ではありませんが。

3. **地形の自然性**: 極端な値の設定は不自然な地形を生成する可能性があります。段階的に調整することを推奨します。

4. **グリッドサイズとの関係**: 一部のパラメータ（特に距離系）は、グリッドサイズに応じて適切に調整する必要があります。

## デバッグとトラブルシューティング
いろいろいじってみたときのやらかし集です

### 地形が生成されない場合
- 距離閾値が大きすぎないか確認
- 高さ・湿度閾値が適切か確認
- 連続性閾値が厳しすぎないか確認

### 地形が多すぎる場合
- 距離閾値を大きくする
- 高さ・湿度閾値を厳しくする
- 連続性閾値を厳しくする

### 地形の分布が偏っている場合
- ノイズのスケールを調整
- 水辺ポイントの配置を確認
- 連続性の設定を見直す

## ユーザが調整しやすいパラメータ
今後余裕があったらユーザが調整できるようにしたいので、まとめます。

### 初心者向け（調整しやすい）

#### 水辺・砂浜の調整
```typescript
WATER: {
  EDGE_THRESHOLD_RATIO: 0.12,        // 水辺エリアの広さ（推奨範囲: 0.1-0.2）
  POINT_STRENGTH_MIN: 0.9,           // 水辺の強度（推奨範囲: 0.7-1.5）
  POINT_STRENGTH_MAX: 1.2,           // 水辺の強度（推奨範囲: 0.7-1.5）
}

BEACH: {
  THRESHOLD_OFFSET: 8,               // 砂浜エリアの広さ（推奨範囲: 5-15）
  HEIGHT_THRESHOLD: 0.6,             // 砂浜生成の高さ（推奨範囲: 0.4-0.8）
}
```

**調整のコツ:**
- `EDGE_THRESHOLD_RATIO`: 0.1（狭い水辺）→ 0.15（広い水辺）
- `THRESHOLD_OFFSET`: 5（狭い砂浜）→ 12（広い砂浜）
- `POINT_STRENGTH_MIN/MAX`: 0.7（弱い水辺）→ 1.5（強い水辺）

#### 地形の生成量調整
```typescript
MOUNTAIN: {
  HEIGHT_THRESHOLD: 0.575,           // 山岳生成の高さ（推奨範囲: 0.5-0.8）
  BASE_CHANCE: 0.9,                  // 山岳生成確率（推奨範囲: 0.7-1.0）
}

FOREST: {
  HEIGHT_THRESHOLD_HIGH: 0.425,      // 森林生成の高さ（推奨範囲: 0.3-0.6）
  MOISTURE_THRESHOLD_HIGH: 0.525,    // 森林生成の湿度（推奨範囲: 0.4-0.7）
}
```

**調整のコツ:**
- 山岳を増やしたい: `HEIGHT_THRESHOLD`を0.5に下げる
- 森林を増やしたい: `HEIGHT_THRESHOLD_HIGH`を0.35に下げる
- 確率を上げたい: `BASE_CHANCE`を0.95に上げる

### 中級者向け（効果が分かりやすい）

#### ノイズの調整
```typescript
NOISE: {
  HEIGHT_SCALE: 0.025,               // 地形の起伏（推奨範囲: 0.01-0.05）
  MOISTURE_SCALE: 0.04,              // 湿度の変化（推奨範囲: 0.02-0.08）
  OCTAVES: 5,                        // 地形の複雑さ（推奨範囲: 3-7）
}
```

**調整のコツ:**
- 平坦な地形: `HEIGHT_SCALE`を0.01に設定
- 起伏の多い地形: `HEIGHT_SCALE`を0.04に設定
- 単純な地形: `OCTAVES`を3に設定
- 複雑な地形: `OCTAVES`を7に設定

#### 連続性の調整
```typescript
MOUNTAIN: {
  CONTINUITY_THRESHOLD: 0.325,       // 山岳の連続性（推奨範囲: 0.2-0.5）
}

FOREST: {
  CONTINUITY_THRESHOLD: 0.4,         // 森林の連続性（推奨範囲: 0.2-0.5）
}
```

**調整のコツ:**
- 連続した地形: 値を0.2-0.3に設定
- 分散した地形: 値を0.4-0.5に設定

### 上級者向け（細かい調整）

#### 距離系パラメータ
```typescript
MOUNTAIN: {
  WATER_DISTANCE_MIN: 20,            // 山岳生成の最小水辺距離
}

FOREST: {
  WATER_DISTANCE_MIN: 22,            // 森林生成の最小水辺距離
  WATER_DISTANCE_MID_MIN: 10,        // 中距離森林生成の最小距離
  WATER_DISTANCE_MID_MAX: 15,        // 中距離森林生成の最大距離
}
```

#### 湿度系パラメータ
```typescript
FOREST: {
  MOISTURE_THRESHOLD_MID: 0.6,       // 中地森林生成の湿度
  MOISTURE_THRESHOLD_LOW: 0.65,      // 低地森林生成の湿度
}
```
